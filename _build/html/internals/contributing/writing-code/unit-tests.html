

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Unit tests &mdash; Django 1.10.dev20160423182652 文档</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="Django 1.10.dev20160423182652 文档" href="../../../index.html"/>
        <link rel="up" title="Writing code" href="index.html"/>
        <link rel="next" title="Submitting patches" href="submitting-patches.html"/>
        <link rel="prev" title="Coding style" href="coding-style.html"/> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../contents.html" class="icon icon-home"> Django
          

          
          </a>

          
            
            
              <div class="version">
                1.10
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../index.html">Django 最新中文文档</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../intro/index.html">开始</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../topics/index.html">Using Django</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../howto/index.html">&#8220;How-to&#8221; guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/index.html">Django FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ref/index.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc/index.html">元文件和杂记</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../releases/index.html">Release notes</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">Django internals</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../index.html">Contributing to Django</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../new-contributors.html">Advice for new contributors</a></li>
<li class="toctree-l3"><a class="reference internal" href="../bugs-and-features.html">Reporting bugs and requesting features</a></li>
<li class="toctree-l3"><a class="reference internal" href="../triaging-tickets.html">Triaging tickets</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="index.html">Writing code</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="coding-style.html">Coding style</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="">Unit tests</a></li>
<li class="toctree-l4"><a class="reference internal" href="submitting-patches.html">Submitting patches</a></li>
<li class="toctree-l4"><a class="reference internal" href="working-with-git.html">Working with Git and GitHub</a></li>
<li class="toctree-l4"><a class="reference internal" href="javascript.html">JavaScript</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../writing-documentation.html">Writing documentation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../localizing.html">Localizing Django</a></li>
<li class="toctree-l3"><a class="reference internal" href="../committing-code.html">Committing code</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../mailing-lists.html">Mailing lists</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../organization.html">Organization of the Django Project</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../team.html">Django team</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../roles.html">Roles</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../security.html">Django&#8217;s security policies</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../release-process.html">Django&#8217;s release process</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../deprecation.html">Django Deprecation Timeline</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../git.html">The Django source code repository</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../howto-release-django.html">How is Django Formed?</a></li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../../contents.html">Django</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../contents.html">Docs</a> &raquo;</li>
      
          <li><a href="../../index.html">Django internals</a> &raquo;</li>
      
          <li><a href="../index.html">Contributing to Django</a> &raquo;</li>
      
          <li><a href="index.html">Writing code</a> &raquo;</li>
      
    <li>Unit tests</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../../_sources/internals/contributing/writing-code/unit-tests.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="s-unit-tests">
<span id="unit-tests"></span><h1>Unit tests<a class="headerlink" href="#unit-tests" title="永久链接至标题">¶</a></h1>
<p>Django comes with a test suite of its own, in the <code class="docutils literal"><span class="pre">tests</span></code> directory of the
code base. It&#8217;s our policy to make sure all tests pass at all times.</p>
<p>We appreciate any and all contributions to the test suite!</p>
<p>The Django tests all use the testing infrastructure that ships with Django for
testing applications. See <a class="reference internal" href="../../../topics/testing/overview.html"><em>Writing and running tests</em></a> for an explanation of
how to write new tests.</p>
<div class="section" id="s-running-the-unit-tests">
<span id="s-running-unit-tests"></span><span id="running-the-unit-tests"></span><span id="running-unit-tests"></span><h2>Running the unit tests<a class="headerlink" href="#running-the-unit-tests" title="永久链接至标题">¶</a></h2>
<div class="section" id="s-quickstart">
<span id="quickstart"></span><h3>Quickstart<a class="headerlink" href="#quickstart" title="永久链接至标题">¶</a></h3>
<p>If you are on Python 2, you&#8217;ll first need to install a backport of the
<code class="docutils literal"><span class="pre">unittest.mock</span></code> module that&#8217;s available in Python 3. See
<a class="reference internal" href="#running-unit-tests-dependencies"><span>Running all the tests</span></a> for details on installing <a class="reference external" href="https://pypi.python.org/pypi/mock">mock</a> and
the other optional test dependencies.</p>
<p>Running the tests requires a Django settings module that defines the
databases to use. To make it easy to get started, Django provides and uses a
sample settings module that uses the SQLite database. To run the tests:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> git clone https://github.com/django/django.git django-repo
<span class="gp">$</span> <span class="nb">cd</span> django-repo/tests
<span class="gp">$</span> <span class="nv">PYTHONPATH</span><span class="o">=</span>..:<span class="nv">$PYTHONPATH</span> ./runtests.py
</pre></div>
</div>
<div class="admonition-windows-users admonition">
<p class="first admonition-title">Windows users</p>
<p class="last">We recommend something like <a class="reference external" href="https://msysgit.github.io/">Git Bash</a> to run
the tests using the above approach.</p>
</div>
<p>You can avoid typing the <code class="docutils literal"><span class="pre">PYTHONPATH</span></code> bit each time by adding your Django
checkout to your <code class="docutils literal"><span class="pre">PYTHONPATH</span></code> or by installing the source checkout using pip.
See <a class="reference internal" href="../../../topics/install.html#installing-development-version"><span>Installing the development version</span></a>.</p>
<p>Having problems? See <a class="reference internal" href="#troubleshooting-unit-tests"><span>Troubleshooting</span></a> for some common issues.</p>
</div>
<div class="section" id="s-using-another-settings-module">
<span id="s-running-unit-tests-settings"></span><span id="using-another-settings-module"></span><span id="running-unit-tests-settings"></span><h3>Using another <code class="docutils literal"><span class="pre">settings</span></code> module<a class="headerlink" href="#using-another-settings-module" title="永久链接至标题">¶</a></h3>
<p>The included settings module (<code class="docutils literal"><span class="pre">tests/test_sqlite.py</span></code>) allows you to run the
test suite using SQLite. If you want to run the tests using a different
database, you&#8217;ll need to define your own settings file. Some tests, such as
those for <code class="docutils literal"><span class="pre">contrib.postgres</span></code>, are specific to a particular database backend
and will be skipped if run with a different backend.</p>
<p>To run the tests with different settings, ensure that the module is on your
<code class="docutils literal"><span class="pre">PYTHONPATH</span></code> and pass the module with <code class="docutils literal"><span class="pre">--settings</span></code>.</p>
<p>The <a class="reference internal" href="../../../ref/settings.html#std:setting-DATABASES"><code class="xref std std-setting docutils literal"><span class="pre">DATABASES</span></code></a> setting in any test settings module needs to define
two databases:</p>
<ul class="simple">
<li>A <code class="docutils literal"><span class="pre">default</span></code> database. This database should use the backend that
you want to use for primary testing.</li>
<li>A database with the alias <code class="docutils literal"><span class="pre">other</span></code>. The <code class="docutils literal"><span class="pre">other</span></code> database is used to test
that queries can be directed to different databases. This database should use
the same backend as the <code class="docutils literal"><span class="pre">default</span></code>, and it must have a different name.</li>
</ul>
<p>If you&#8217;re using a backend that isn&#8217;t SQLite, you will need to provide other
details for each database:</p>
<ul class="simple">
<li>The <a class="reference internal" href="../../../ref/settings.html#std:setting-USER"><code class="xref std std-setting docutils literal"><span class="pre">USER</span></code></a> option needs to specify an existing user account
for the database. That user needs permission to execute <code class="docutils literal"><span class="pre">CREATE</span> <span class="pre">DATABASE</span></code>
so that the test database can be created.</li>
<li>The <a class="reference internal" href="../../../ref/settings.html#std:setting-PASSWORD"><code class="xref std std-setting docutils literal"><span class="pre">PASSWORD</span></code></a> option needs to provide the password for
the <a class="reference internal" href="../../../ref/settings.html#std:setting-USER"><code class="xref std std-setting docutils literal"><span class="pre">USER</span></code></a> that has been specified.</li>
</ul>
<p>Test databases get their names by prepending <code class="docutils literal"><span class="pre">test_</span></code> to the value of the
<a class="reference internal" href="../../../ref/settings.html#std:setting-NAME"><code class="xref std std-setting docutils literal"><span class="pre">NAME</span></code></a> settings for the databases defined in <a class="reference internal" href="../../../ref/settings.html#std:setting-DATABASES"><code class="xref std std-setting docutils literal"><span class="pre">DATABASES</span></code></a>.
These test databases are deleted when the tests are finished.</p>
<p>You will also need to ensure that your database uses UTF-8 as the default
character set. If your database server doesn&#8217;t use UTF-8 as a default charset,
you will need to include a value for <a class="reference internal" href="../../../ref/settings.html#std:setting-TEST_CHARSET"><code class="xref std std-setting docutils literal"><span class="pre">CHARSET</span></code></a> in the
test settings dictionary for the applicable database.</p>
</div>
<div class="section" id="s-running-only-some-of-the-tests">
<span id="s-runtests-specifying-labels"></span><span id="running-only-some-of-the-tests"></span><span id="runtests-specifying-labels"></span><h3>Running only some of the tests<a class="headerlink" href="#running-only-some-of-the-tests" title="永久链接至标题">¶</a></h3>
<p>Django&#8217;s entire test suite takes a while to run, and running every single test
could be redundant if, say, you just added a test to Django that you want to
run quickly without running everything else. You can run a subset of the unit
tests by appending the names of the test modules to <code class="docutils literal"><span class="pre">runtests.py</span></code> on the
command line.</p>
<p>For example, if you&#8217;d like to run tests only for generic relations and
internationalization, type:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> ./runtests.py --settings<span class="o">=</span>path.to.settings generic_relations i18n
</pre></div>
</div>
<p>How do you find out the names of individual tests? Look in <code class="docutils literal"><span class="pre">tests/</span></code> — each
directory name there is the name of a test.</p>
<p>If you just want to run a particular class of tests, you can specify a list of
paths to individual test classes. For example, to run the <code class="docutils literal"><span class="pre">TranslationTests</span></code>
of the <code class="docutils literal"><span class="pre">i18n</span></code> module, type:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> ./runtests.py --settings<span class="o">=</span>path.to.settings i18n.tests.TranslationTests
</pre></div>
</div>
<p>Going beyond that, you can specify an individual test method like this:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> ./runtests.py --settings<span class="o">=</span>path.to.settings i18n.tests.TranslationTests.test_lazy_objects
</pre></div>
</div>
</div>
<div class="section" id="s-running-the-selenium-tests">
<span id="running-the-selenium-tests"></span><h3>Running the Selenium tests<a class="headerlink" href="#running-the-selenium-tests" title="永久链接至标题">¶</a></h3>
<p>Some tests require Selenium and a Web browser. To run these tests, you must
install the <a class="reference external" href="https://pypi.python.org/pypi/selenium">selenium</a> package and run the tests with the
<code class="docutils literal"><span class="pre">--selenium=&lt;BROWSERS&gt;</span></code> option. For example, if you have Firefox and Google
Chrome installed:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> ./runtests.py --selenium<span class="o">=</span>firefox,chrome
</pre></div>
</div>
<p>See the <a class="reference external" href="https://github.com/SeleniumHQ/selenium/tree/master/py/selenium/webdriver">selenium.webdriver</a> package for the list of available browsers.</p>
<p>Specifying <code class="docutils literal"><span class="pre">--selenium</span></code> automatically sets <code class="docutils literal"><span class="pre">--tags=selenium</span></code> to run only
the tests that require selenium.</p>
</div>
<div class="section" id="s-running-all-the-tests">
<span id="s-running-unit-tests-dependencies"></span><span id="running-all-the-tests"></span><span id="running-unit-tests-dependencies"></span><h3>Running all the tests<a class="headerlink" href="#running-all-the-tests" title="永久链接至标题">¶</a></h3>
<p>If you want to run the full suite of tests, you&#8217;ll need to install a number of
dependencies:</p>
<ul class="simple">
<li><a class="reference external" href="https://pypi.python.org/pypi/argon2_cffi">argon2-cffi</a> 16.0.0+</li>
<li><a class="reference external" href="https://pypi.python.org/pypi/bcrypt">bcrypt</a></li>
<li><a class="reference external" href="https://pypi.python.org/pypi/docutils">docutils</a></li>
<li><a class="reference external" href="https://pypi.python.org/pypi/enum34">enum34</a> (Python 2 only)</li>
<li><a class="reference external" href="https://pypi.python.org/pypi/geoip2">geoip2</a></li>
<li><a class="reference external" href="https://pypi.python.org/pypi/jinja2">jinja2</a> 2.7+</li>
<li><a class="reference external" href="https://pypi.python.org/pypi/numpy">numpy</a></li>
<li><a class="reference external" href="https://pypi.python.org/pypi/Pillow/">Pillow</a></li>
<li><a class="reference external" href="http://pyyaml.org/wiki/PyYAML">PyYAML</a></li>
<li><a class="reference external" href="https://pypi.python.org/pypi/pytz/">pytz</a></li>
<li><a class="reference external" href="https://pypi.python.org/pypi/setuptools/">setuptools</a></li>
<li><a class="reference external" href="http://memcached.org/">memcached</a>, plus a <a class="reference internal" href="../../../topics/cache.html#memcached"><span>supported Python binding</span></a></li>
<li><a class="reference external" href="https://pypi.python.org/pypi/mock">mock</a> (for Python 2)</li>
<li><a class="reference external" href="https://www.gnu.org/software/gettext/manual/gettext.html">gettext</a> (<a class="reference internal" href="../../../topics/i18n/translation.html#gettext-on-windows"><span>gettext on Windows</span></a>)</li>
<li><a class="reference external" href="https://pypi.python.org/pypi/selenium">selenium</a></li>
<li><a class="reference external" href="https://pypi.python.org/pypi/sqlparse">sqlparse</a></li>
</ul>
<p>You can find these dependencies in <a class="reference external" href="https://pip.pypa.io/en/latest/user_guide.html#requirements-files">pip requirements files</a> inside the
<code class="docutils literal"><span class="pre">tests/requirements</span></code> directory of the Django source tree and install them
like so:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> pip install -r tests/requirements/py3.txt  <span class="c1"># Python 2: py2.txt</span>
</pre></div>
</div>
<p>You can also install the database adapter(s) of your choice using
<code class="docutils literal"><span class="pre">oracle.txt</span></code>, <code class="docutils literal"><span class="pre">mysql.txt</span></code>, or <code class="docutils literal"><span class="pre">postgres.txt</span></code>.</p>
<p>If you want to test the memcached cache backend, you&#8217;ll also need to define
a <a class="reference internal" href="../../../ref/settings.html#std:setting-CACHES"><code class="xref std std-setting docutils literal"><span class="pre">CACHES</span></code></a> setting that points at your memcached instance.</p>
<p>To run the GeoDjango tests, you will need to <a class="reference internal" href="../../../ref/contrib/gis/install/index.html"><em>setup a spatial database
and install the Geospatial libraries</em></a>.</p>
<p>Each of these dependencies is optional. If you&#8217;re missing any of them, the
associated tests will be skipped.</p>
</div>
<div class="section" id="s-code-coverage">
<span id="code-coverage"></span><h3>Code coverage<a class="headerlink" href="#code-coverage" title="永久链接至标题">¶</a></h3>
<p>Contributors are encouraged to run coverage on the test suite to identify areas
that need additional tests. The coverage tool installation and use is described
in <a class="reference internal" href="../../../topics/testing/advanced.html#topics-testing-code-coverage"><span>testing code coverage</span></a>.</p>
<p>Coverage should be run in a single process to obtain accurate statistics. To
run coverage on the Django test suite using the standard test settings:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> coverage run ./runtests.py --settings<span class="o">=</span>test_sqlite --parallel<span class="o">=</span>1
</pre></div>
</div>
<p>After running coverage, generate the html report by running:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> coverage html
</pre></div>
</div>
<p>When running coverage for the Django tests, the included <code class="docutils literal"><span class="pre">.coveragerc</span></code>
settings file  defines <code class="docutils literal"><span class="pre">coverage_html</span></code> as the output directory for the report
and also excludes several directories not relevant to the results
(test code or external code included in Django).</p>
</div>
</div>
<div class="section" id="s-contrib-apps">
<span id="s-id1"></span><span id="contrib-apps"></span><span id="id1"></span><h2>Contrib apps<a class="headerlink" href="#contrib-apps" title="永久链接至标题">¶</a></h2>
<p>Tests for contrib apps can be found in the <code class="docutils literal"><span class="pre">tests/</span></code> directory, typically
under <code class="docutils literal"><span class="pre">&lt;app_name&gt;_tests</span></code>. For example, tests for <code class="docutils literal"><span class="pre">contrib.auth</span></code> are located
in <code class="docutils literal"><span class="pre">tests/auth_tests</span></code>.</p>
</div>
<div class="section" id="s-troubleshooting">
<span id="s-troubleshooting-unit-tests"></span><span id="troubleshooting"></span><span id="troubleshooting-unit-tests"></span><h2>Troubleshooting<a class="headerlink" href="#troubleshooting" title="永久链接至标题">¶</a></h2>
<div class="section" id="s-many-test-failures-with-unicodeencodeerror">
<span id="many-test-failures-with-unicodeencodeerror"></span><h3>Many test failures with <code class="docutils literal"><span class="pre">UnicodeEncodeError</span></code><a class="headerlink" href="#many-test-failures-with-unicodeencodeerror" title="永久链接至标题">¶</a></h3>
<p>If the <code class="docutils literal"><span class="pre">locales</span></code> package is not installed, some tests will fail with a
<code class="docutils literal"><span class="pre">UnicodeEncodeError</span></code>.</p>
<p>You can resolve this on Debian-based systems, for example, by running:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> apt-get install locales
<span class="gp">$</span> dpkg-reconfigure locales
</pre></div>
</div>
</div>
<div class="section" id="s-tests-that-only-fail-in-combination">
<span id="tests-that-only-fail-in-combination"></span><h3>Tests that only fail in combination<a class="headerlink" href="#tests-that-only-fail-in-combination" title="永久链接至标题">¶</a></h3>
<p>In case a test passes when run in isolation but fails within the whole suite,
we have some tools to help analyze the problem.</p>
<p>The <code class="docutils literal"><span class="pre">--bisect</span></code> option of <code class="docutils literal"><span class="pre">runtests.py</span></code> will run the failing test while
halving the test set it is run together with on each iteration, often making
it possible to identify a small number of tests that may be related to the
failure.</p>
<p>For example, suppose that the failing test that works on its own is
<code class="docutils literal"><span class="pre">ModelTest.test_eq</span></code>, then using:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> ./runtests.py --bisect basic.tests.ModelTest.test_eq
</pre></div>
</div>
<p>will try to determine a test that interferes with the given one. First, the
test is run with the first half of the test suite. If a failure occurs, the
first half of the test suite is split in two groups and each group is then run
with the specified test. If there is no failure with the first half of the test
suite, the second half of the test suite is run with the specified test and
split appropriately as described earlier. The process repeats until the set of
failing tests is minimized.</p>
<p>The <code class="docutils literal"><span class="pre">--pair</span></code> option runs the given test alongside every other test from the
suite, letting you check if another test has side-effects that cause the
failure. So:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> ./runtests.py --pair basic.tests.ModelTest.test_eq
</pre></div>
</div>
<p>will pair <code class="docutils literal"><span class="pre">test_eq</span></code> with every test label.</p>
<p>With both <code class="docutils literal"><span class="pre">--bisect</span></code> and <code class="docutils literal"><span class="pre">--pair</span></code>, if you already suspect which cases
might be responsible for the failure, you may limit tests to be cross-analyzed
by <a class="reference internal" href="#runtests-specifying-labels"><span>specifying further test labels</span></a> after
the first one:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> ./runtests.py --pair basic.tests.ModelTest.test_eq queries transactions
</pre></div>
</div>
<p>You can also try running any set of tests in reverse using the <code class="docutils literal"><span class="pre">--reverse</span></code>
option in order to verify that executing tests in a different order does not
cause any trouble:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> ./runtests.py basic --reverse
</pre></div>
</div>
</div>
<div class="section" id="s-seeing-the-sql-queries-run-during-a-test">
<span id="seeing-the-sql-queries-run-during-a-test"></span><h3>Seeing the SQL queries run during a test<a class="headerlink" href="#seeing-the-sql-queries-run-during-a-test" title="永久链接至标题">¶</a></h3>
<p>If you wish to examine the SQL being run in failing tests, you can turn on
<a class="reference internal" href="../../../topics/logging.html#django-db-logger"><span>SQL logging</span></a> using the <code class="docutils literal"><span class="pre">--debug-sql</span></code> option. If you
combine this with <code class="docutils literal"><span class="pre">--verbosity=2</span></code>, all SQL queries will be output:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> ./runtests.py basic --debug-sql
</pre></div>
</div>
</div>
<div class="section" id="s-seeing-the-full-traceback-of-a-test-failure">
<span id="seeing-the-full-traceback-of-a-test-failure"></span><h3>Seeing the full traceback of a test failure<a class="headerlink" href="#seeing-the-full-traceback-of-a-test-failure" title="永久链接至标题">¶</a></h3>
<p>By default tests are run in parallel with one process per core. When the tests
are run in parallel, however, you&#8217;ll only see a truncated traceback for any
test failures. You can adjust this behavior with the <code class="docutils literal"><span class="pre">--parallel</span></code> option:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> ./runtests.py basic --parallel<span class="o">=</span>1
</pre></div>
</div>
<p>You can also use the <code class="docutils literal"><span class="pre">DJANGO_TEST_PROCESSES</span></code> environment variable for this
purpose.</p>
<div class="versionadded">
<span class="title">New in Django 1.9:</span> <p>Support for running tests in parallel and the <code class="docutils literal"><span class="pre">--parallel</span></code> option were
added.</p>
</div>
</div>
<div class="section" id="s-tips-for-writing-tests">
<span id="tips-for-writing-tests"></span><h3>Tips for writing tests<a class="headerlink" href="#tips-for-writing-tests" title="永久链接至标题">¶</a></h3>
<div class="section" id="s-isolating-model-registration">
<span id="isolating-model-registration"></span><h4>Isolating model registration<a class="headerlink" href="#isolating-model-registration" title="永久链接至标题">¶</a></h4>
<p>To avoid polluting the global <a class="reference internal" href="../../../ref/applications.html#django.apps.apps" title="django.apps.apps"><code class="xref py py-attr docutils literal"><span class="pre">apps</span></code></a> registry and prevent
unnecessary table creation, models defined in a test method should be bound to
a temporary <code class="docutils literal"><span class="pre">Apps</span></code> instance:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.apps.registry</span> <span class="kn">import</span> <span class="n">Apps</span>
<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">django.test</span> <span class="kn">import</span> <span class="n">SimpleTestCase</span>

<span class="k">class</span> <span class="nc">TestModelDefinition</span><span class="p">(</span><span class="n">SimpleTestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">test_model_definition</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">test_apps</span> <span class="o">=</span> <span class="n">Apps</span><span class="p">([</span><span class="s1">&#39;app_label&#39;</span><span class="p">])</span>

        <span class="k">class</span> <span class="nc">TestModel</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
            <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
                <span class="n">apps</span> <span class="o">=</span> <span class="n">test_apps</span>
        <span class="o">...</span>
</pre></div>
</div>
<dl class="function">
<dt id="django.test.utils.isolate_apps">
<code class="descclassname">django.test.utils.</code><code class="descname">isolate_apps</code>(<em>*app_labels</em>, <em>attr_name=None</em>, <em>kwarg_name=None</em>)<a class="headerlink" href="#django.test.utils.isolate_apps" title="永久链接至目标">¶</a></dt>
<dd></dd></dl>

<div class="versionadded">
<span class="title">New in Django Development version.</span> </div>
<p>Since this pattern involves a lot of boilerplate, Django provides the
<a class="reference internal" href="#django.test.utils.isolate_apps" title="django.test.utils.isolate_apps"><code class="xref py py-func docutils literal"><span class="pre">isolate_apps()</span></code></a> decorator. It&#8217;s used like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">django.test</span> <span class="kn">import</span> <span class="n">SimpleTestCase</span>
<span class="kn">from</span> <span class="nn">django.test.utils</span> <span class="kn">import</span> <span class="n">isolate_apps</span>

<span class="k">class</span> <span class="nc">TestModelDefinition</span><span class="p">(</span><span class="n">SimpleTestCase</span><span class="p">):</span>
    <span class="nd">@isolate_apps</span><span class="p">(</span><span class="s1">&#39;app_label&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_model_definition</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">class</span> <span class="nc">TestModel</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="o">...</span>
</pre></div>
</div>
<div class="admonition-setting-app-label admonition">
<p class="first admonition-title">Setting <code class="docutils literal"><span class="pre">app_label</span></code></p>
<p>Models defined in a test method with no explicit
<a class="reference internal" href="../../../ref/models/options.html#django.db.models.Options.app_label" title="django.db.models.Options.app_label"><code class="xref py py-attr docutils literal"><span class="pre">app_label</span></code></a> are automatically assigned the
label of the app in which their test class is located.</p>
<p>In order to make sure the models defined within the context of
<a class="reference internal" href="#django.test.utils.isolate_apps" title="django.test.utils.isolate_apps"><code class="xref py py-func docutils literal"><span class="pre">isolate_apps()</span></code></a> instances are correctly
installed, you should pass the set of targeted <code class="docutils literal"><span class="pre">app_label</span></code> as arguments:</p>
<div class="last highlight-python"><div class="snippet-filename">tests/app_label/tests.py</div>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">django.test</span> <span class="kn">import</span> <span class="n">SimpleTestCase</span>
<span class="kn">from</span> <span class="nn">django.test.utils</span> <span class="kn">import</span> <span class="n">isolate_apps</span>

<span class="k">class</span> <span class="nc">TestModelDefinition</span><span class="p">(</span><span class="n">SimpleTestCase</span><span class="p">):</span>
    <span class="nd">@isolate_apps</span><span class="p">(</span><span class="s1">&#39;app_label&#39;</span><span class="p">,</span> <span class="s1">&#39;other_app_label&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_model_definition</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># This model automatically receives app_label=&#39;app_label&#39;</span>
        <span class="k">class</span> <span class="nc">TestModel</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
            <span class="k">pass</span>

        <span class="k">class</span> <span class="nc">OtherAppModel</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
            <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
                <span class="n">app_label</span> <span class="o">=</span> <span class="s1">&#39;other_app_label&#39;</span>
        <span class="o">...</span>
</pre></div>
</div>
</div>
<p>The decorator can also be applied to classes:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">django.test</span> <span class="kn">import</span> <span class="n">SimpleTestCase</span>
<span class="kn">from</span> <span class="nn">django.test.utils</span> <span class="kn">import</span> <span class="n">isolate_apps</span>

<span class="nd">@isolate_apps</span><span class="p">(</span><span class="s1">&#39;app_label&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">TestModelDefinition</span><span class="p">(</span><span class="n">SimpleTestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">test_model_definition</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">class</span> <span class="nc">TestModel</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="o">...</span>
</pre></div>
</div>
<p>The temporary <code class="docutils literal"><span class="pre">Apps</span></code> instance used to isolate model registration can be
retrieved as an attribute when used as a class decorator by using the
<code class="docutils literal"><span class="pre">attr_name</span></code> parameter:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">django.test</span> <span class="kn">import</span> <span class="n">SimpleTestCase</span>
<span class="kn">from</span> <span class="nn">django.test.utils</span> <span class="kn">import</span> <span class="n">isolate_apps</span>

<span class="nd">@isolate_apps</span><span class="p">(</span><span class="s1">&#39;app_label&#39;</span><span class="p">,</span> <span class="n">attr_name</span><span class="o">=</span><span class="s1">&#39;apps&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">TestModelDefinition</span><span class="p">(</span><span class="n">SimpleTestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">test_model_definition</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">class</span> <span class="nc">TestModel</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">apps</span><span class="o">.</span><span class="n">get_model</span><span class="p">(</span><span class="s1">&#39;app_label&#39;</span><span class="p">,</span> <span class="s1">&#39;TestModel&#39;</span><span class="p">),</span> <span class="n">TestModel</span><span class="p">)</span>
</pre></div>
</div>
<p>Or as an argument on the test method when used as a method decorator by using
the <code class="docutils literal"><span class="pre">kwarg_name</span></code> parameter:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">django.test</span> <span class="kn">import</span> <span class="n">SimpleTestCase</span>
<span class="kn">from</span> <span class="nn">django.test.utils</span> <span class="kn">import</span> <span class="n">isolate_apps</span>

<span class="k">class</span> <span class="nc">TestModelDefinition</span><span class="p">(</span><span class="n">SimpleTestCase</span><span class="p">):</span>
    <span class="nd">@isolate_apps</span><span class="p">(</span><span class="s1">&#39;app_label&#39;</span><span class="p">,</span> <span class="n">kwarg_name</span><span class="o">=</span><span class="s1">&#39;apps&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_model_definition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">apps</span><span class="p">):</span>
        <span class="k">class</span> <span class="nc">TestModel</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIs</span><span class="p">(</span><span class="n">apps</span><span class="o">.</span><span class="n">get_model</span><span class="p">(</span><span class="s1">&#39;app_label&#39;</span><span class="p">,</span> <span class="s1">&#39;TestModel&#39;</span><span class="p">),</span> <span class="n">TestModel</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="submitting-patches.html" class="btn btn-neutral float-right" title="Submitting patches" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="coding-style.html" class="btn btn-neutral" title="Coding style" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; 版权所有 Django Software Foundation and contributors.
      最后更新于 Apr 27, 2016.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'1.10.dev20160423182652',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>
      <script type="text/javascript" src="../../../_static/translations.js"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>