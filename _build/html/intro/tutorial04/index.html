

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>编写你的第一个Django应用，第4部分 &mdash; Django 1.10.dev20160423182652 文档</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="Django 1.10.dev20160423182652 文档" href="../../"/>
        <link rel="up" title="开始" href="../"/>
        <link rel="next" title="编写你的第一个Django应用，第5部分" href="../tutorial05/"/>
        <link rel="prev" title="编写你的第一个Django应用，第3部分" href="../tutorial03/"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../contents/" class="icon icon-home"> Django
          

          
          </a>

          
            
            
              <div class="version">
                1.10
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search/" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../../">Django 最新中文文档</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../">开始</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../overview/">初识 Django</a></li>
<li class="toctree-l2"><a class="reference internal" href="../install/">快速安装指南</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorial01/">编写你的第一个Django应用，第1部分</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorial02/">编写你的第一个Django应用，第2部分</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorial03/">编写你的第一个Django应用，第3部分</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="">编写你的第一个Django应用，第4部分</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#write-a-simple-form">编写一个简单的表单</a></li>
<li class="toctree-l3"><a class="reference internal" href="#use-generic-views-less-code-is-better">使用通用视图：代码还是少点好</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#amend-urlconf">改良 URLconf</a></li>
<li class="toctree-l4"><a class="reference internal" href="#amend-views">改良视图</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../tutorial05/">编写你的第一个Django应用，第5部分</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorial06/">编写你的第一个Django应用，第6部分</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorial07/">编写你的第一个Django应用，第7部分</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reusable-apps/">Advanced tutorial: How to write reusable apps</a></li>
<li class="toctree-l2"><a class="reference internal" href="../whatsnext/">What to read next</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contributing/">编写你的第一个Django补丁</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../topics/">Using Django</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../howto/">&#8220;How-to&#8221; guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../faq/">Django FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ref/">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../misc/">元文件和杂记</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../glossary/">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../releases/">Release notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../internals/">Django internals</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../contents/">Django</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../contents/">Docs</a> &raquo;</li>
      
          <li><a href="../">开始</a> &raquo;</li>
      
    <li>编写你的第一个Django应用，第4部分</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../_sources/intro/tutorial04.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="s-writing-your-first-django-app-part-4">
<span id="writing-your-first-django-app-part-4"></span><h1>编写你的第一个Django应用，第4部分<a class="headerlink" href="#writing-your-first-django-app-part-4" title="永久链接至标题">¶</a></h1>
<p>这一篇从 <a class="reference internal" href="../tutorial03/"><em>Tutorial 3</em></a>  结尾的地方继续讲起。我们将继续编写投票应用，专注于简单的表单处理并且精简我们的代码。</p>
<div class="section" id="s-write-a-simple-form">
<span id="write-a-simple-form"></span><h2>编写一个简单的表单<a class="headerlink" href="#write-a-simple-form" title="永久链接至标题">¶</a></h2>
<p>让我们更新一下在上一个教程中编写的投票详细页面的模板  (&#8220;polls/detail.html&#8221;) ，让它包含一个 HTML <code class="docutils literal"><span class="pre">&lt;form&gt;</span></code> 元素：</p>
<div class="highlight-html+django"><div class="snippet-filename">polls/templates/polls/detail.html</div>
<div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span><span class="cp">{{</span> <span class="nv">question.question_text</span> <span class="cp">}}</span><span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>

<span class="cp">{%</span> <span class="k">if</span> <span class="nv">error_message</span> <span class="cp">%}</span><span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;&lt;</span><span class="nt">strong</span><span class="p">&gt;</span><span class="cp">{{</span> <span class="nv">error_message</span> <span class="cp">}}</span><span class="p">&lt;/</span><span class="nt">strong</span><span class="p">&gt;&lt;/</span><span class="nt">p</span><span class="p">&gt;</span><span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span>

<span class="p">&lt;</span><span class="nt">form</span> <span class="na">action</span><span class="o">=</span><span class="s">&quot;</span><span class="cp">{%</span> <span class="k">url</span> <span class="s1">&#39;polls:vote&#39;</span> <span class="nv">question.id</span> <span class="cp">%}</span><span class="s">&quot;</span> <span class="na">method</span><span class="o">=</span><span class="s">&quot;post&quot;</span><span class="p">&gt;</span>
<span class="cp">{%</span> <span class="k">csrf_token</span> <span class="cp">%}</span>
<span class="cp">{%</span> <span class="k">for</span> <span class="nv">choice</span> <span class="k">in</span> <span class="nv">question.choice_set.all</span> <span class="cp">%}</span>
    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;radio&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;choice&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;choice</span><span class="cp">{{</span> <span class="nb">forloop</span><span class="nv">.counter</span> <span class="cp">}}</span><span class="s">&quot;</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;</span><span class="cp">{{</span> <span class="nv">choice.id</span> <span class="cp">}}</span><span class="s">&quot;</span> <span class="p">/&gt;</span>
    <span class="p">&lt;</span><span class="nt">label</span> <span class="na">for</span><span class="o">=</span><span class="s">&quot;choice</span><span class="cp">{{</span> <span class="nb">forloop</span><span class="nv">.counter</span> <span class="cp">}}</span><span class="s">&quot;</span><span class="p">&gt;</span><span class="cp">{{</span> <span class="nv">choice.choice_text</span> <span class="cp">}}</span><span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;&lt;</span><span class="nt">br</span> <span class="p">/&gt;</span>
<span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span>
<span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;submit&quot;</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;Vote&quot;</span> <span class="p">/&gt;</span>
<span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
</pre></div>
</div>
<p>简要说明：</p>
<ul class="simple">
<li><p class="first">上面的模板在 Question 的每个 Choice 前添加一个单选按钮。 每个单选按钮的 <code class="docutils literal"><span class="pre">value</span></code> 属性是对应的各个 Choice 的 ID。每个单选按钮的 <code class="docutils literal"><span class="pre">name</span></code> 是 <code class="docutils literal"><span class="pre">&quot;choice&quot;</span></code> 。这意味着，当有人选择一个单选按钮并提交表单提交时，它将发送一个 POST 数据 <code class="docutils literal"><span class="pre">choice=#</span></code> ，其中# 为选择的 Choice 的 ID。这是 HTML 表单的基本概念。</p>
</li>
<li><p class="first">我们设置表单的 <code class="docutils literal"><span class="pre">action</span></code> 为 <code class="docutils literal"><span class="pre">{%</span> <span class="pre">url</span> <span class="pre">'polls:vote'</span> <span class="pre">question.id</span> <span class="pre">%}</span></code> ，并设置  <code class="docutils literal"><span class="pre">method=&quot;post&quot;</span></code> 。使用 <code class="docutils literal"><span class="pre">method=&quot;post&quot;``(与其相对的是</span> <span class="pre">``method=&quot;get&quot;</span></code>)是非常重要的，因为这个提交表单的行为会改变服务器端的数据。 无论何时，当你需要创建一个改变服务器端数据的表单时，请使用 <code class="docutils literal"><span class="pre">method=&quot;post&quot;</span></code> 。这不是 Django 的特定技巧；这是优秀的网站开发实践。</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">forloop.counter</span></code> 指示 <a class="reference internal" href="../../ref/templates/builtins/#std:templatetag-for"><code class="xref std std-ttag docutils literal"><span class="pre">for</span></code></a> 标签已经循环多少次。</p>
</li>
<li><p class="first">由于我们创建一个 POST 表单(它具有修改数据的作用)，所以我们需要小心跨站点请求伪造。 谢天谢地，你不必太过担心，因为 Django 已经拥有一个用来防御它的非常容易使用的系统。 简而言之，所有针对内部 URL 的 POST 表单都应该使用  <a class="reference internal" href="../../ref/templates/builtins/#std:templatetag-csrf_token"><code class="xref std std-ttag docutils literal"><span class="pre">{%</span> <span class="pre">csrf_token</span> <span class="pre">%}</span></code></a> 模板标签。</p>
</li>
</ul>
<p>现在，让我们来创建一个 Django 视图来处理提交的数据。记住，在 <a class="reference internal" href="../tutorial03/"><em>教程第3部分</em></a> 中，我们为投票应用创建了一个 URLconf ，包含这一行：</p>
<div class="highlight-python"><div class="snippet-filename">polls/urls.py</div>
<div class="highlight"><pre><span></span><span class="n">url</span><span class="p">(</span><span class="s1">r&#39;^(?P&lt;question_id&gt;[0-9]+)/vote/$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">vote</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;vote&#39;</span><span class="p">),</span>
</pre></div>
</div>
<p>我们还创建了一个 <code class="docutils literal"><span class="pre">vote()</span></code> 函数的虚拟实现。让我们来创建一个真实的版本。 将下面的代码添加到 <code class="docutils literal"><span class="pre">polls/views.py</span></code> ：</p>
<div class="highlight-python"><div class="snippet-filename">polls/views.py</div>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">get_object_or_404</span><span class="p">,</span> <span class="n">render</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponseRedirect</span><span class="p">,</span> <span class="n">HttpResponse</span>
<span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">reverse</span>

<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">Choice</span><span class="p">,</span> <span class="n">Question</span>
<span class="c1"># ...</span>
<span class="k">def</span> <span class="nf">vote</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">question_id</span><span class="p">):</span>
    <span class="n">question</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Question</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">question_id</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">selected_choice</span> <span class="o">=</span> <span class="n">question</span><span class="o">.</span><span class="n">choice_set</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s1">&#39;choice&#39;</span><span class="p">])</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="n">Choice</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">):</span>
        <span class="c1"># Redisplay the question voting form.</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;polls/detail.html&#39;</span><span class="p">,</span> <span class="p">{</span>
            <span class="s1">&#39;question&#39;</span><span class="p">:</span> <span class="n">question</span><span class="p">,</span>
            <span class="s1">&#39;error_message&#39;</span><span class="p">:</span> <span class="s2">&quot;You didn&#39;t select a choice.&quot;</span><span class="p">,</span>
        <span class="p">})</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">selected_choice</span><span class="o">.</span><span class="n">votes</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">selected_choice</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="c1"># Always return an HttpResponseRedirect after successfully dealing</span>
        <span class="c1"># with POST data. This prevents data from being posted twice if a</span>
        <span class="c1"># user hits the Back button.</span>
        <span class="k">return</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;polls:results&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">question</span><span class="o">.</span><span class="n">id</span><span class="p">,)))</span>
</pre></div>
</div>
<p>以上代码中有些内容还未在本教程中提到过：</p>
<ul>
<li><p class="first"><a class="reference internal" href="../../ref/request-response/#django.http.HttpRequest.POST" title="django.http.HttpRequest.POST"><code class="xref py py-attr docutils literal"><span class="pre">request.POST</span></code></a>  是一个类字典对象，让你可以通过关键字的名字获取提交的数据。 这个例子中， <code class="docutils literal"><span class="pre">request.POST['choice']</span></code> 以字符串形式返回选择的 Choice 的 ID。 <a class="reference internal" href="../../ref/request-response/#django.http.HttpRequest.POST" title="django.http.HttpRequest.POST"><code class="xref py py-attr docutils literal"><span class="pre">request.POST</span></code></a>  的值永远是字符串。</p>
<p>注意，Django 还以同样的方式提供 <a class="reference internal" href="../../ref/request-response/#django.http.HttpRequest.GET" title="django.http.HttpRequest.GET"><code class="xref py py-attr docutils literal"><span class="pre">request.GET</span></code></a>  用于访问 GET 数据 —— 但我们在代码中显式地使用 <a class="reference internal" href="../../ref/request-response/#django.http.HttpRequest.POST" title="django.http.HttpRequest.POST"><code class="xref py py-attr docutils literal"><span class="pre">request.POST</span></code></a>  ，以保证数据只能通过POST调用改动。</p>
</li>
<li><p class="first">如果在 <code class="docutils literal"><span class="pre">request.POST['choice']</span></code>  数据中没有提供 <code class="docutils literal"><span class="pre">choice</span></code> ， POST 将引发一个 <a class="reference external" href="https://docs.python.org/3/library/exceptions.html#KeyError" title="(在 Python v3.5)"><code class="xref py py-exc docutils literal"><span class="pre">KeyError</span></code></a> 。上面的代码检查 <a class="reference external" href="https://docs.python.org/3/library/exceptions.html#KeyError" title="(在 Python v3.5)"><code class="xref py py-exc docutils literal"><span class="pre">KeyError</span></code></a> ，如果没有给出 <code class="docutils literal"><span class="pre">choice</span></code> 将重新显示Question表单和一个错误信息。</p>
</li>
<li><p class="first">在增加Choice的得票数之后，代码返回一个 <a class="reference internal" href="../../ref/request-response/#django.http.HttpResponseRedirect" title="django.http.HttpResponseRedirect"><code class="xref py py-class docutils literal"><span class="pre">HttpResponseRedirect</span></code></a> 而不是常用的 <a class="reference internal" href="../../ref/request-response/#django.http.HttpResponse" title="django.http.HttpResponse"><code class="xref py py-class docutils literal"><span class="pre">HttpResponse</span></code></a>  、 <a class="reference internal" href="../../ref/request-response/#django.http.HttpResponseRedirect" title="django.http.HttpResponseRedirect"><code class="xref py py-class docutils literal"><span class="pre">HttpResponseRedirect</span></code></a>  只接收一个参数：用户将要被重定向的 URL(请继续看下去，我们将会解释如何构造这个例子中的 URL)。</p>
<p>As the Python comment above points out, you should always return an
<a class="reference internal" href="../../ref/request-response/#django.http.HttpResponseRedirect" title="django.http.HttpResponseRedirect"><code class="xref py py-class docutils literal"><span class="pre">HttpResponseRedirect</span></code></a> after successfully dealing with
POST data. This tip isn&#8217;t specific to Django; it&#8217;s just good Web
development practice.</p>
</li>
<li><p class="first">We are using the <a class="reference internal" href="../../ref/urlresolvers/#django.urls.reverse" title="django.urls.reverse"><code class="xref py py-func docutils literal"><span class="pre">reverse()</span></code></a> function in the
<a class="reference internal" href="../../ref/request-response/#django.http.HttpResponseRedirect" title="django.http.HttpResponseRedirect"><code class="xref py py-class docutils literal"><span class="pre">HttpResponseRedirect</span></code></a> constructor in this example.
This function helps avoid having to hardcode a URL in the view function.
It is given the name of the view that we want to pass control to and the
variable portion of the URL pattern that points to that view. In this
case, using the URLconf we set up in <a class="reference internal" href="../tutorial03/"><em>Tutorial 3</em></a>,
this <a class="reference internal" href="../../ref/urlresolvers/#django.urls.reverse" title="django.urls.reverse"><code class="xref py py-func docutils literal"><span class="pre">reverse()</span></code></a> call will return a string like</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="s1">&#39;/polls/3/results/&#39;</span>
</pre></div>
</div>
<p>其中 <code class="docutils literal"><span class="pre">3</span></code> 是 <code class="docutils literal"><span class="pre">question.id</span></code> 的值。重定向的 URL 将调用 <code class="docutils literal"><span class="pre">'results'</span></code> 视图来显示最终的页面。</p>
</li>
</ul>
<p>正如在 <a class="reference internal" href="../tutorial03/"><em>教程第三部分</em></a> 中提到的，<a class="reference internal" href="../../ref/request-response/#django.http.HttpRequest" title="django.http.HttpRequest"><code class="xref py py-class docutils literal"><span class="pre">HttpRequest</span></code></a> 是一个 <a class="reference internal" href="../../ref/request-response/#django.http.HttpRequest" title="django.http.HttpRequest"><code class="xref py py-class docutils literal"><span class="pre">HttpRequest</span></code></a> 对象。更多关于 <a class="reference internal" href="../../ref/request-response/#django.http.HttpRequest" title="django.http.HttpRequest"><code class="xref py py-class docutils literal"><span class="pre">HttpRequest</span></code></a> 对象的内容，请参见  :doc:` 请求和响应的文档 &lt;/ref/request-response&gt;` 。</p>
<p>当有人对 Question 进行投票后，  <code class="docutils literal"><span class="pre">vote()</span></code> 视图将请求重定向到 Question 的结果界面。让我们来编写这个视图：</p>
<div class="highlight-python"><div class="snippet-filename">polls/views.py</div>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">get_object_or_404</span><span class="p">,</span> <span class="n">render</span>


<span class="k">def</span> <span class="nf">results</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">question_id</span><span class="p">):</span>
    <span class="n">question</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Question</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">question_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;polls/results.html&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;question&#39;</span><span class="p">:</span> <span class="n">question</span><span class="p">})</span>
</pre></div>
</div>
<p>这和 <a class="reference internal" href="../tutorial03/"><em>教程第3部分</em></a> 中的  <code class="docutils literal"><span class="pre">detail()</span></code> 视图几乎一模一样。唯一的不同是模板的名字。 我们将在稍后解决这个冗余问题。</p>
<p>现在，创建一个 <code class="docutils literal"><span class="pre">polls/results.html</span></code>  模板：</p>
<div class="highlight-html+django"><div class="snippet-filename">polls/templates/polls/results.html</div>
<div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span><span class="cp">{{</span> <span class="nv">question.question_text</span> <span class="cp">}}</span><span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
<span class="cp">{%</span> <span class="k">for</span> <span class="nv">choice</span> <span class="k">in</span> <span class="nv">question.choice_set.all</span> <span class="cp">%}</span>
    <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span><span class="cp">{{</span> <span class="nv">choice.choice_text</span> <span class="cp">}}</span> -- <span class="cp">{{</span> <span class="nv">choice.votes</span> <span class="cp">}}</span> vote<span class="cp">{{</span> <span class="nv">choice.votes</span><span class="o">|</span><span class="nf">pluralize</span> <span class="cp">}}</span><span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span>
<span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;</span><span class="cp">{%</span> <span class="k">url</span> <span class="s1">&#39;polls:detail&#39;</span> <span class="nv">question.id</span> <span class="cp">%}</span><span class="s">&quot;</span><span class="p">&gt;</span>Vote again?<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
</pre></div>
</div>
<p>现在，在你的浏览器中访问 <code class="docutils literal"><span class="pre">/polls/1/</span></code> 然后为 Question 投票。你应该看到一个投票结果页面，并且在你每次投票之后都会更新。 如果你提交时没有选择任何Choice，你应该看到错误信息。</p>
<div class="admonition note">
<p class="first admonition-title">注解</p>
<p>The code for our <code class="docutils literal"><span class="pre">vote()</span></code> view does have a small problem. It first gets
the <code class="docutils literal"><span class="pre">selected_choice</span></code> object from the database, then computes the new
value of <code class="docutils literal"><span class="pre">votes</span></code>, and then saves it back to the database. If two users of
your website try to vote at <em>exactly the same time</em>, this might go wrong:
The same value, let&#8217;s say 42, will be retrieved for <code class="docutils literal"><span class="pre">votes</span></code>. Then, for
both users the new value of 43 is computed and saved, but 44 would be the
expected value.</p>
<p class="last">This is called a <em>race condition</em>. If you are interested, you can read
<a class="reference internal" href="../../ref/models/expressions/#avoiding-race-conditions-using-f"><span>Avoiding race conditions using F()</span></a> to learn how you can solve this
issue.</p>
</div>
</div>
<div class="section" id="s-use-generic-views-less-code-is-better">
<span id="use-generic-views-less-code-is-better"></span><h2>使用通用视图：代码还是少点好<a class="headerlink" href="#use-generic-views-less-code-is-better" title="永久链接至标题">¶</a></h2>
<p><code class="docutils literal"><span class="pre">detail()</span></code>  (在 <a class="reference internal" href="../tutorial03/"><em>教程第3部分</em></a> 中)和 <code class="docutils literal"><span class="pre">results()</span></code> 视图都很简单 —— 并且，像上面提到的那样，存在冗余问题。用来显示一个议题列表的 <code class="docutils literal"><span class="pre">index()</span></code>  视图（也在 <a class="reference internal" href="../tutorial03/"><em>教程第3部分</em></a> 中）和它们类似。</p>
<p>这些视图反映基本的 Web 开发中的一个常见情况：根据 URL 中的参数从数据库中获取数据、载入模板文件然后返回渲染后的模板。 由于这种情况特别常见，Django 提供一种快捷方式，叫做“通用视图”系统。</p>
<p>通用视图将常见的模式抽象化，可以使你在编写应用时甚至不需要编写Python代码。</p>
<p>让我们将我们的投票应用转换成使用通用视图系统，这样我们可以删除许多我们的代码。我们仅仅需要做以下几步来完成转换： 我们将：</p>
<ol class="arabic simple">
<li><p class="first">转换 URLconf。</p>
</li>
<li><p class="first">删除一些旧的、不再需要的代码。</p>
</li>
<li><p class="first">引进基于 Django 通用视图的新视图。</p>
</li>
</ol>
<p>请继续阅读来了解详细信息。</p>
<div class="admonition-why-the-code-shuffle admonition">
<p class="first admonition-title">为什么要重构代码？</p>
<p>一般来说，当编写一个 Django 应用时，你应该先评估一下通用视图是否可以解决你的问题，你应该在一开始使用它，而不是进行到一半时重构代码。本教程目前为止是有意将重点放在以“艰难的方式”编写视图，这是为将重点放在核心概念上。</p>
<p class="last">就像在使用计算器之前你需要知道基本的数学一样。</p>
</div>
<div class="section" id="s-amend-urlconf">
<span id="amend-urlconf"></span><h3>改良 URLconf<a class="headerlink" href="#amend-urlconf" title="永久链接至标题">¶</a></h3>
<p>首先，打开 <code class="docutils literal"><span class="pre">polls/urls.py</span></code> 这个 URLconf 并将它修改成：</p>
<div class="highlight-python"><div class="snippet-filename">polls/urls.py</div>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">url</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">views</span>

<span class="n">app_name</span> <span class="o">=</span> <span class="s1">&#39;polls&#39;</span>
<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">url</span><span class="p">(</span><span class="s1">r&#39;^$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">IndexView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="s1">r&#39;^(?P&lt;pk&gt;[0-9]+)/$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">DetailView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;detail&#39;</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="s1">r&#39;^(?P&lt;pk&gt;[0-9]+)/results/$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">ResultsView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;results&#39;</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="s1">r&#39;^(?P&lt;question_id&gt;[0-9]+)/vote/$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">vote</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;vote&#39;</span><span class="p">),</span>
<span class="p">]</span>
</pre></div>
</div>
<p>注意在第二个和第三个模式的正则表达式中，匹配的模式的名字由  <code class="docutils literal"><span class="pre">&lt;question_id&gt;</span></code> 变成 <code class="docutils literal"><span class="pre">&lt;pk&gt;</span></code> 。</p>
</div>
<div class="section" id="s-amend-views">
<span id="amend-views"></span><h3>改良视图<a class="headerlink" href="#amend-views" title="永久链接至标题">¶</a></h3>
<p>下一步，我们将删除旧的 <code class="docutils literal"><span class="pre">index</span></code>, <code class="docutils literal"><span class="pre">detail</span></code>, 和 <code class="docutils literal"><span class="pre">results</span></code> 视图，并用 Django 的通用视图代替。打开 <code class="docutils literal"><span class="pre">polls/views.py</span></code> 文件，并将它修改成：</p>
<div class="highlight-python"><div class="snippet-filename">polls/views.py</div>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">get_object_or_404</span><span class="p">,</span> <span class="n">render</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponseRedirect</span>
<span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">reverse</span>
<span class="kn">from</span> <span class="nn">django.views</span> <span class="kn">import</span> <span class="n">generic</span>

<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">Choice</span><span class="p">,</span> <span class="n">Question</span>


<span class="k">class</span> <span class="nc">IndexView</span><span class="p">(</span><span class="n">generic</span><span class="o">.</span><span class="n">ListView</span><span class="p">):</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;polls/index.html&#39;</span>
    <span class="n">context_object_name</span> <span class="o">=</span> <span class="s1">&#39;latest_question_list&#39;</span>

    <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the last five published questions.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Question</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-pub_date&#39;</span><span class="p">)[:</span><span class="mi">5</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">DetailView</span><span class="p">(</span><span class="n">generic</span><span class="o">.</span><span class="n">DetailView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Question</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;polls/detail.html&#39;</span>


<span class="k">class</span> <span class="nc">ResultsView</span><span class="p">(</span><span class="n">generic</span><span class="o">.</span><span class="n">DetailView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Question</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;polls/results.html&#39;</span>


<span class="k">def</span> <span class="nf">vote</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">question_id</span><span class="p">):</span>
    <span class="o">...</span> <span class="c1"># same as above, no changes needed.</span>
</pre></div>
</div>
<p>我们在这里使用两个通用视图： <a class="reference internal" href="../../ref/class-based-views/generic-display/#django.views.generic.list.ListView" title="django.views.generic.list.ListView"><code class="xref py py-class docutils literal"><span class="pre">ListView</span></code></a> 和 <a class="reference internal" href="../../ref/class-based-views/generic-display/#django.views.generic.detail.DetailView" title="django.views.generic.detail.DetailView"><code class="xref py py-class docutils literal"><span class="pre">DetailView</span></code></a> 。这两个视图分别抽象“显示一个对象列表”和“显示一个特定类型对象的详细信息页面”这两种概念。</p>
<ul class="simple">
<li><p class="first">每个通用视图需要知道它将作用于哪个模型。 这由 <code class="docutils literal"><span class="pre">model</span></code> 属性提供。</p>
</li>
<li><p class="first"><a class="reference internal" href="../../ref/class-based-views/generic-display/#django.views.generic.detail.DetailView" title="django.views.generic.detail.DetailView"><code class="xref py py-class docutils literal"><span class="pre">DetailView</span></code></a>  期望从 URL 中捕获名为   <code class="docutils literal"><span class="pre">&quot;pk&quot;</span></code> 的主键值，所以我们为通用视图把 <code class="docutils literal"><span class="pre">question_id</span></code> 改成 <code class="docutils literal"><span class="pre">pk</span></code> 。</p>
</li>
</ul>
<p>默认情况下，通用视图 <a class="reference internal" href="../../ref/class-based-views/generic-display/#django.views.generic.detail.DetailView" title="django.views.generic.detail.DetailView"><code class="xref py py-class docutils literal"><span class="pre">DetailView</span></code></a> 使用一个叫做 <code class="docutils literal"><span class="pre">&lt;app</span> <span class="pre">name&gt;/&lt;model</span> <span class="pre">name&gt;_detail.html</span></code> 的模板。在我们的例子中，它将使用 <code class="docutils literal"><span class="pre">&quot;polls/question_detail.html&quot;</span></code> 模板。<code class="docutils literal"><span class="pre">template_name</span></code> 属性是用来告诉Django使用一个指定的模板名字，而不是自动生成的默认名字。 我们也为 <code class="docutils literal"><span class="pre">results</span></code> 列表视图指定了 <code class="docutils literal"><span class="pre">template_name</span></code>  —— 这确保results视图和detail视图在渲染时具有不同的外观，即使它们在后台都是同一个 <a class="reference internal" href="../../ref/class-based-views/generic-display/#django.views.generic.detail.DetailView" title="django.views.generic.detail.DetailView"><code class="xref py py-class docutils literal"><span class="pre">DetailView</span></code></a> 。</p>
<p>类似地，<a class="reference internal" href="../../ref/class-based-views/generic-display/#django.views.generic.list.ListView" title="django.views.generic.list.ListView"><code class="xref py py-class docutils literal"><span class="pre">ListView</span></code></a> 使用一个叫做  <code class="docutils literal"><span class="pre">&lt;app</span> <span class="pre">name&gt;/&lt;model</span> <span class="pre">name&gt;_list.html</span></code> 的默认模板；我们使用 <code class="docutils literal"><span class="pre">template_name</span></code> 来告诉 <a class="reference internal" href="../../ref/class-based-views/generic-display/#django.views.generic.list.ListView" title="django.views.generic.list.ListView"><code class="xref py py-class docutils literal"><span class="pre">ListView</span></code></a> 使用我们自己已经存在的 <code class="docutils literal"><span class="pre">&quot;polls/index.html&quot;</span></code> 模板。</p>
<p>在之前的教程中，提供模板文件时都带有一个包含 <code class="docutils literal"><span class="pre">question</span></code> 和 <code class="docutils literal"><span class="pre">latest_question_list</span></code> 变量的 context。对于 <code class="docutils literal"><span class="pre">DetailView</span></code> ， <code class="docutils literal"><span class="pre">question</span></code>  变量会自动提供—— 因为我们使用 Django 的模型 (Question)， Django 能够为context 变量决定一个合适的名字。然而对于ListView， 自动生成的context 变量是 <code class="docutils literal"><span class="pre">question_list</span></code> 。为了覆盖这个行为，我们提供 <code class="docutils literal"><span class="pre">context_object_name</span></code>  属性，表示我们想使用 <code class="docutils literal"><span class="pre">latest_question_list</span></code> 。作为一种替换方案，你可以改变你的模板来匹配新的 context 变量 —— 但它告诉 Django 使用你想使用的变量名更容易多了。</p>
<p>启动服务器，使用一下基于通用视图的新投票应用。</p>
<p>更多关于通用视图的详细信息，请查看 <a class="reference internal" href="../../topics/class-based-views/"><em>通用视图的文档</em></a></p>
<p>当你对你所写的表单和通用视图感到满意后，请阅读 <a class="reference internal" href="../tutorial05/"><em>教程的第5部分</em></a> 来了解如何测试我们的投票应用。</p>
</div>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../tutorial05/" class="btn btn-neutral float-right" title="编写你的第一个Django应用，第5部分" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../tutorial03/" class="btn btn-neutral" title="编写你的第一个Django应用，第3部分" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; 版权所有 Django Software Foundation and contributors.
      最后更新于 Jul 07, 2016.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1.10.dev20160423182652',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="../../_static/translations.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>